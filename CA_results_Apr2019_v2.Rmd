---
title: "Sunk Cost and House Price"
author: "DR and VY"
date: "March, 2019"
output: 
  html_document:
    css: bodycss.css
    toc: yes
    number_section: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE,message = FALSE)
```

```{r}
rm(list=ls())
library(stargazer)
library(plyr)
library(lfe)
library(zoo)
library(scales)
library(rdrobust)
library(data.table)
library(ggplot2)
library(dplyr)

note =c("Fixed Effects: census tract, listing month, ownership cohort","Standard Errors clustered by census tract")
output.type="text"
printtable <- function(reg,column.labels,note,lines) {
  stargazer(reg,type=output.type,no.space = TRUE,omit.stat = c("f","rsq","ser"),notes= note,column.labels = column.labels, dep.var.labels = "",dep.var.labels.include = FALSE,add.lines = lines)
}




zdata <- readRDS(file="C:/Users/dnratnadiwakara/Documents/sunkcost_2019/zillow_ztrax_Mar2019_5.rds")
zdata[,Selling_premium:=zdata$sales_price/zdata$adj_purch_price]
zdata[,Renter_fraction:=zdata$renters/zdata$totalpopulation]
zdata[,Purchase_price:=SalesPriceAmount_prev]
zdata[,Listing_price:=listing_amount]
zdata[,Selling_price:=sales_price]
zdata[,Listing_premium:=list_premium]
zdata[,Property_tax_last_year:=prop_tax_prev_year]
zdata[,Property_tax_rate_last_year:=prop_tax_rate]

# zdata <- rename(zdata,replace=c(
#                               "SalesPriceAmount_prev"="Purchase_price",
#                               "listing_amount"="Listing_price",
#                               "sales_price"="Selling_price",
#                               "list_premium"="Listing_premium",
#                               "prop_tax_prev_year"="Property_tax_last_year",
#                               "prop_tax_rate" = "Property_tax_rate_last_year"))

zdata_reg <- zdata[zdata$ListingYear>2013 & zdata$Listing_premium<1.5 & zdata$Listing_premium>0.8 & zdata$ownership_years>=4 & zdata$house_age>0 ]
zdata_reg[,ownership_cohort:=ntile(zdata_reg$ownership_years,10)]
zdata_reg[,Time_on_market:=as.numeric(zdata_reg$sale_date)-as.numeric(zdata_reg$listed_date)+1]

```



```{r}
zdata_reg <- data.table(mutate(zdata_reg,min_asmt=pmin(assesment_2007,assesment_2008,assesment_2009,assesment_2010,assesment_2011,assesment_2012,na.rm = TRUE)))
zdata_reg[,affected_by_prop_8_2:=ifelse(zdata_reg$min_asmt>0 & !is.na(zdata_reg$min_asmt) & zdata_reg$PurchaseYear<2007 & zdata_reg$min_asmt<zdata_reg$Purchase_price,1,0)]

zdata_reg[,zip_list_month:=paste(zdata_reg$zip,zdata_reg$ListingMonth)]
zdata_reg[,tract_list_month:=paste(zdata_reg$GEOID,zdata_reg$ListingMonth)]
zdata_reg[,zip_sale_month:=sapply(zdata_reg$sale_date,function(x) substr(x,1,7))]
zdata_reg[,zip_sale_month:=paste(zdata_reg$zip,zdata_reg$zip_sale_month)]

zdata_reg[,Tax_rate:=zdata_reg$prop_tax_rate]
zdata_reg[,Ownership_years:=zdata_reg$ownership_years]
zdata_reg[,Adj_purch_price:=zdata_reg$adj_purch_price]
zdata_reg[,Bedrooms:=zdata_reg$beds]
zdata_reg[,Bathrooms:=zdata_reg$baths]
zdata_reg[,HPI_purchase:=zdata_reg$purchase_hpi]

zdata_reg[,nominal_loss:=ifelse(zdata_reg$purchase_hpi>zdata_reg$listing_hpi,zdata_reg$Purchase_price-zdata_reg$Adj_purch_price,1)]

```

```{r}
CA_all <- readRDS(file="C:/Users/dnratnadiwakara/Documents/sunkcost_2019/perv_transactions/CA_prev_transaction_merged_2.rds")
CA_all[,House_age:=CA_all$Sale_year-CA_all$YearBuilt]
CA_all[,nominal_loss:=ifelse(CA_all$HPI_purchase>CA_all$HPI_sale,CA_all$Purchase_price-CA_all$Adj_purch_price,1)]
CA_all[,zip_sale_month:=paste(CA_all$zip,CA_all$Sale_month)]
```


```{r}

IL <- readRDS(file="C:/Users/dnratnadiwakara/Documents/sunkcost_2019/perv_transactions/IL_prev_transaction_merged.rds")
AZ <- readRDS(file="C:/Users/dnratnadiwakara/Documents/sunkcost_2019/perv_transactions/AZ_prev_transaction_merged.rds")
NY <- readRDS(file="C:/Users/dnratnadiwakara/Documents/sunkcost_2019/perv_transactions/NY_prev_transaction_merged.rds")
OR <- readRDS(file="C:/Users/dnratnadiwakara/Documents/sunkcost_2019/perv_transactions/OR_prev_transaction_merged.rds")
# NV <- readRDS(file="C:/Users/dnratnadiwakara/Documents/sunkcost_2019/perv_transactions/NV_prev_transaction_merged.rds")
# OR <- readRDS(file="C:/Users/dnratnadiwakara/Documents/sunkcost_2019/perv_transactions/OR_prev_transaction_merged.rds")
# FL <- readRDS(file="C:/Users/dnratnadiwakara/Documents/sunkcost_2019/perv_transactions/FL_prev_transaction_merged.rds")

prev_trans <- rbind(IL,AZ)
prev_trans <- rbind(prev_trans,NY)
prev_trans <- rbind(prev_trans,OR)
# prev_trans <- rbind(prev_trans,FL)
prev_trans[,House_age:=prev_trans$Sale_year-prev_trans$YearBuilt]
prev_trans[,Sale_price:=prev_trans$SalesPriceAmount_sale]
prev_trans[,State:=sapply(prev_trans$FIPS, function(x) substr(as.character(x),1,nchar(x)-3))]

prev_trans[,zip_sale_month:=paste(prev_trans$zip,prev_trans$Sale_month)]

prev_trans[,nominal_loss:=ifelse(prev_trans$HPI_purchase>prev_trans$HPI_sale,prev_trans$Purchase_price-prev_trans$Adj_purch_price,1)]

rm(list=c("IL","AZ","NV","OR","FL","NY"))
```

```{r}
# AZ <- readRDS(file="C:/Users/dnratnadiwakara/Documents/sunkcost_2019/all_homes_prev/AZ_all_homes_prev.rds")
CA <- readRDS(file="C:/Users/dnratnadiwakara/Documents/sunkcost_2019/all_homes_prev/CA_all_homes_prev.rds")
IL <- readRDS(file="C:/Users/dnratnadiwakara/Documents/sunkcost_2019/all_homes_prev/IL_all_homes_prev.rds")
NY <- readRDS(file="C:/Users/dnratnadiwakara/Documents/sunkcost_2019/all_homes_prev/NY_all_homes_prev.rds")


all_homes_prev <- rbind(CA,IL)
# all_homes_prev <- rbind(all_homes_prev,IL)
all_homes_prev <- rbind(all_homes_prev,NY)
all_homes_prev[,Ownership_years:=2016-all_homes_prev$Purchase_year]
all_homes_prev <- all_homes_prev[all_homes_prev$Ownership_years>2]

all_homes_prev[,tax_rate_2014:=all_homes_prev$tax_2014/all_homes_prev$Adj_purch_price]
all_homes_prev[,tax_rate_2015:=all_homes_prev$tax_2015/all_homes_prev$Adj_purch_price]
all_homes_prev[,tax_rate_2016:=all_homes_prev$tax_2016/all_homes_prev$Adj_purch_price]
all_homes_prev<-all_homes_prev[(all_homes_prev$tax_rate_2015>0 & all_homes_prev$tax_rate_2015<0.1) | (all_homes_prev$tax_rate_2016>0 & all_homes_prev$tax_rate_2016<0.1)| (all_homes_prev$tax_rate_2014>0 & all_homes_prev$tax_rate_2014<0.1)]

all_homes_prev[,nominal_loss:=ifelse(all_homes_prev$HPI_purchase>all_homes_prev$HPI_asmt,all_homes_prev$SalesPriceAmount-all_homes_prev$Adj_purch_price,1)]

all_homes_prev[,House_age:=2016-all_homes_prev$YearBuilt]

# ownership_year_group <- data.frame(ownership_year_group=c("lt 5","lt 5","lt 5","6-10","6-10","6-10","6-10","6-10","11-15","11-15","11-15","11-15","11-15","16-20","16-20","16-20","16-20","16-20"),Ownership_years=3:20,stringsAsFactors = FALSE)
# 
# all_homes_prev <- merge(all_homes_prev,ownership_year_group,by="Ownership_years")

rm(list=c("IL","AZ","NV","OR","FL","NY"))
```


# Descriptive Statistics
```{r}
stargazer(zdata_reg[,c("Purchase_price","adj_purch_price","Listing_price","Listing_premium",
                       "Selling_premium","Property_tax_last_year","Property_tax_rate_last_year",
                       "affected_by_prop_8","purchase_hpi","hpi_inflation","ownership_years",
                       "beds","baths","sqft","LotSizeSquareFeet","house_age","LTV_prev",
                       "avg_school_rating","avg_school_distance","totalpopulation","medianage","medianhouseholdincome","Renter_fraction")],type=output.type,summary.stat = c("mean","sd","p25","median","p75","n"),digits = 4)
```

# Instrument Validation

```{r include=FALSE,eval=FALSE}

## California: Property tax rate and HPI at purchase

temp <- zdata_reg[zdata_reg$PurchaseYear<=2011]
temp[,DocumentDate_prev:=as.Date(temp$DocumentDate_prev,origin = "1970-01-01")]
temp[,purchased_quarter:=as.yearqtr(temp$DocumentDate_prev)]

temp <- temp[,.(tax_rate=mean(Property_tax_rate_last_year)*100,purchase_hpi=mean(purchase_hpi)/1000),
             by=list(purchased_quarter)]

g1 <- ggplot(temp,aes(x=purchased_quarter))+ geom_line(aes(y=temp$tax_rate,linetype="Tax Rate"),size=0.8)+ geom_line(aes(y=temp$purchase_hpi/400,linetype="Median House Price"),size=0.8)+
  scale_color_manual(name="Colors",values=c("Median House Price"="black","Tax Rate"="black"))+scale_y_continuous(sec.axis = sec_axis(~.*400, name = "Median House Price $'000"))+labs(y = "Tax Rate (%)",x = "Purchased Year",colour = NULL)+ theme_minimal()+theme(legend.position="bottom",legend.direction="horizontal",legend.title=element_blank(),        axis.ticks.y=element_blank(),legend.key.width=unit(5,"line"),legend.key = element_blank())+ggtitle("")
g1
```


```{r include=FALSE,eval=FALSE}
## Illinos: Property tax rate and HPI at purchase
# for(state in c("17","12","41")) {
hpi_tax <- function(state) {
 temp <- prev_trans[prev_trans$Sale_year %in% 2013:2015 & prev_trans$State==state]
temp[,purchased_quarter:=as.yearqtr(temp$Purchase_date)]
temp <- temp[temp$Purchase_year<2011 & temp$Tax_rate>0.01 & temp$Tax_rate<0.04]

temp <- temp[,.(tax_rate=mean(Tax_rate)*100,purchase_hpi=median(HPI_purchase)/1000),
             by=list(purchased_quarter)]
scale=100
gr <- ggplot(temp,aes(x=purchased_quarter))+ geom_line(aes(y=tax_rate,linetype="Tax Rate"),size=0.8,show.legend = TRUE)+ geom_line(aes(y=purchase_hpi/scale,linetype="Median House Price"),size=0.8,show.legend = TRUE)+
  scale_color_manual(name="Colors",values=c("Median House Price"="black","Tax Rate"="black"))+scale_y_continuous(sec.axis = sec_axis(~.*scale, name = "Median House Price $'000"))+labs(y = "Tax Rate (%)",x = "Purchased Year",colour = NULL)+ theme_minimal()+theme(legend.position="bottom",legend.direction="horizontal",legend.title=element_blank(),        axis.ticks.y=element_blank(),legend.key.width=unit(5,"line"),legend.key = element_blank())+ggtitle("")
  
 return(gr)
}
hpi_tax("17")
# hpi_tax("12")
```

## California: Within censustract variation of property tax rate
```{r}
temp <- zdata_reg[zdata_reg$PurchaseYear<=2011]

zip_tax_rate <- temp[,.(mean_tax_rate=mean(Property_tax_rate_last_year)),
             by=list(GEOID)]

temp <- merge(temp,zip_tax_rate,by=c("GEOID"))

temp[,tax_variation:= (temp$Property_tax_rate_last_year-temp$mean_tax_rate)*100]

q1<-qplot(temp$tax_variation,geom="histogram",xlab="Tax Rate - Mean Censustract Tax Rate (%)",ylab="Number of Listings",col=I("black"))+ theme_minimal()+xlim(-1,1)+scale_y_continuous(labels = comma)
q1
```

## Property Taxes and Years of Ownership


```{r}
year_summary <- all_homes_prev[all_homes_prev$Adj_purch_price>100000 & all_homes_prev$Adj_purch_price<1500000,.(tax_rate_2016=median(tax_2016,na.rm=TRUE),tax_rate_2015=median(tax_2015,na.rm=TRUE),tax_rate_2014=median(tax_2014,na.rm=TRUE)),by=list(State,Purchase_year)]

year_summary[,median_tax:=ifelse(year_summary$State %in% c("CA","NY"),year_summary$tax_rate_2016,ifelse(year_summary$State=="AZ",year_summary$tax_rate_2015,ifelse(year_summary$State %in% c("IL"),year_summary$tax_rate_2014,NA)))]

ggplot()+geom_line(data=year_summary[!year_summary$State %in% c("AZ")],aes(x=Purchase_year,y=median_tax,linetype=factor(State)))+theme_minimal()+theme(legend.position="bottom",legend.direction="horizontal",legend.title=element_blank(),        axis.ticks.y=element_blank(),legend.key.width=unit(5,"line"),legend.key = element_blank())+
  geom_rect(data=data.frame(xmin=1996,xmax=2007,ymin=2000,ymax=11000),aes(xmin=xmin,xmax=xmax,ymin=ymin,ymax=ymax),fill="darkgreen",alpha=0.2)+
  geom_rect(data=data.frame(xmin=2008,xmax=2012,ymin=2000,ymax=11000),aes(xmin=xmin,xmax=xmax,ymin=ymin,ymax=ymax),fill="darkred",alpha=0.1)+xlab("Year of purchase")+ylab("Median Tax 2016")
```

## Effect of Years of Ownership on List Price (California)
Using zillow sample.

```{r}
regs <- list()

controls = "log(adj_purch_price)+log(nominal_loss)+beds+baths+sqft+avg_school_rating+avg_school_distance+walk_score+log(house_age)+log(LotSizeSquareFeet)+LTV_prev"
fe = "|zip_list_month|"
cluster = "|zip"
instruments = "ownership_years" #
endo_var = "Property_tax_rate_last_year"



regs <- list()
regs[[1]] <- felm(as.formula(paste("log(Listing_price)~ownership_years+",controls,fe,"0",cluster,sep="")),data=zdata_reg[zdata_reg$PurchaseYear<2008])
regs[[2]] <- felm(as.formula(paste("log(Listing_price)~ownership_years+",controls,fe,"0",cluster,sep="")),data=zdata_reg[zdata_reg$PurchaseMonth>="2009-04-01" & zdata_reg$PurchaseMonth<="2012-09-01"])

printtable(regs,column.labels = c("CA: 1996-2007", "CA: 2009-2012"),note="",
           lines=list(c("FE:","Zip x List Month","Tract x List Month","Zip x Sale Month","Zip x Sale Month"),c("Cluster:","Zip","Tract","Zip","Zip")))

```


## Effect of Years of Ownership on Sales Price
Using ZTRAX data.

```{r}
note =c("Fixed Effects: Zip X Month, Tract X Month, Zip x Month","SE Clustered by Zip, Tract, Zip")

regs <- list()
regs[[1]] <- felm(as.formula(paste("log(SalesPriceAmount_sale)~Ownership_years+","log(Adj_purch_price)+log(nominal_loss)+Bedrooms+Bathrooms+log(House_age)+BuildingAreaSqFt","|zip_sale_month|","0","|zip",sep="")),data=CA_all[CA_all$Purchase_year<2007 & CA_all$Sale_year>2014 & CA_all$House_age>6 & CA_all$Sale_premium<1.3 ])
regs[[2]] <- felm(as.formula(paste("log(Sale_price)~Ownership_years+","log(Adj_purch_price)+log(nominal_loss)+Bedrooms+Bathrooms+log(House_age)+BuildingAreaSqFt","|zip_sale_month|","0","|zip",sep="")),data=prev_trans[prev_trans$State=="17" & prev_trans$Purchase_year<2008 & prev_trans$Sale_year>2014 & prev_trans$House_age>6 & prev_trans$Sale_premium<1.3])
regs[[3]] <- felm(as.formula(paste("log(Sale_price)~Ownership_years+","log(Adj_purch_price)+log(nominal_loss)+Bedrooms+Bathrooms+log(House_age)+BuildingAreaSqFt","|zip_sale_month|","0","|zip",sep="")),data=prev_trans[prev_trans$State=="36" & prev_trans$Purchase_year<2008 & prev_trans$Sale_year>2014 & prev_trans$House_age>6 & prev_trans$Sale_premium<1.3])


printtable(regs,column.labels = c("CA","IL","NY"),note="",
           lines=list(c("FE:","Zip x List Month","Tract x List Month","Zip x Sale Month","Zip x Sale Month"),c("Cluster:","Zip","Tract","Zip","Zip")))
```



# Effect on Listing price (Sample: Homes purchased before 2008)

```{r}

zd <- zdata_reg[zdata_reg$PurchaseYear<2008]
controls = "log(adj_purch_price)+log(nominal_loss)+beds+baths+sqft+avg_school_rating+avg_school_distance+walk_score+log(house_age)+log(LotSizeSquareFeet)+LTV_prev"
fe = "|zip_list_month|"
cluster = "|zip"
instruments = "ownership_years" #
endo_var = "Property_tax_rate_last_year"



regs <- list()
regs[[1]] <- felm(as.formula(paste("log(Listing_price)~Property_tax_rate_last_year+",controls,fe,"0",cluster,sep="")),data=zd)
regs[[2]] <- felm(as.formula(paste("log(Listing_price)~",controls,fe,"(",endo_var,"~",instruments,")",cluster,sep="")),data=zd)
# regs[[3]] <- felm(as.formula(paste("log(Listing_price)~",controls,fe,"(",endo_var,"~",instruments,")",cluster,sep="")),data=zd)
# regs[[3]] <- felm(as.formula(paste("log(Listing_price)~",controls,"|zip_list_month+ownership_cohort|","(",endo_var,"~",instruments,")",cluster,sep="")),data=zdata_reg)
regs[[3]] <- felm(as.formula(paste("log(Listing_price)~",controls,"+medianage+medianhouseholdincome+Renter_fraction|zip_list_month|","(",endo_var,"~",instruments,")","|zip",sep="")),data=zd)
# regs[[4]] <- felm(as.formula(paste("log(Listing_price)~",controls,"|zip_list_month+GEOID|","(",endo_var,"~",instruments,")","|zip",sep="")),data=zdata_reg)


condf <- list(
  c("Cond. F. Stat","",round(condfstat(regs[[2]])[[1]],2),round(condfstat(regs[[3]])[[1]],2)),
  c("Fixed Effects","Zip X List Month","Zip x List Month","Zip X List Month","Zip X List Month, Tract"),
  c("Cluster","Zip","Zip","Tract","Zip")
  )
printtable(regs,column.labels = c("OLS","IV","IV","IV"),note="",lines=condf)

ols_formula <- as.formula(paste("log(Listing_price)~Property_tax_rate_last_year+",controls,fe,"0",cluster,sep=""))
iv_formula <- as.formula(paste("log(Listing_price)~",controls,fe,"(",endo_var,"~",instruments,")",cluster,sep=""))

```

# Effect on Listing price: Variation by Expected Loss
```{r}


regs <- list()
regs[[1]] <- felm(ols_formula,data=zd[zd$purchase_hpi>zd$listing_hpi])
regs[[2]] <- felm(ols_formula,data=zd[zd$purchase_hpi<=zd$listing_hpi])
regs[[3]] <- felm(iv_formula,data=zd[zd$purchase_hpi>zd$listing_hpi])
regs[[4]] <- felm(iv_formula,data=zd[zd$purchase_hpi<=zd$listing_hpi])
regs[[5]] <- felm(iv_formula,data=zd[zd$affected_by_prop_8==1])
regs[[6]] <- felm(iv_formula,data=zd[zd$affected_by_prop_8==0])

printtable(regs,column.labels = c("OLS-HPIp>HPIl","OLS-HPIp<HPIl","IV-HPIp>HPIl","IV-HPIp<HPIl","IV-Prop 8 = 1","IV-Prop 8 = 0"),note=note,lines=list(""))
```



```{r eval=FALSE,include=FALSE}
# Effect on Sales price: Variation by Expected Loss

regs <- list()
regs[[1]] <- felm(ols_formula_selling_price,data=zdata_reg[zdata_reg$purchase_hpi>zdata_reg$listing_hpi])
regs[[2]] <- felm(ols_formula_selling_price,data=zdata_reg[zdata_reg$purchase_hpi<=zdata_reg$listing_hpi])
regs[[3]] <- felm(iv_formula_selling_price,data=zdata_reg[zdata_reg$purchase_hpi>zdata_reg$listing_hpi])
regs[[4]] <- felm(iv_formula_selling_price,data=zdata_reg[zdata_reg$purchase_hpi<=zdata_reg$listing_hpi])
regs[[5]] <- felm(iv_formula_selling_price,data=zdata_reg[zdata_reg$affected_by_prop_8==1])
regs[[6]] <- felm(iv_formula_selling_price,data=zdata_reg[zdata_reg$affected_by_prop_8==0])

printtable(regs,column.labels = c("OLS-HPIp>HPIl","OLS-HPIp<HPIl","IV-HPIp>HPIl","IV-HPIp<HPIl","IV-Prop 8 = 1","IV-Prop 8 = 0"),note=note,lines=list(""))
```




# Effect on Listing price: Variation by Property Price Category
```{r}
regs <- list()
regs[[1]] <- felm(ols_formula,data=zd[zd$Listing_price<zd$listing_q2])
regs[[2]] <- felm(iv_formula,data=zd[zd$Listing_price<zd$listing_q2])
regs[[3]] <- felm(ols_formula,data=zd[zd$Listing_price>zd$listing_q2])
regs[[4]] <- felm(iv_formula,data=zd[zd$Listing_price>zd$listing_q2])

printtable(regs,column.labels = c("Low Value (OLS)","Low Value (IV)","High Value (OLS)","High Value (IV)"),note=note,lines=list(""))
```



```{r eval=FALSE,include=FALSE}
# Effect on Sales price: Variation by Property Price Category

regs <- list()
regs[[1]] <- felm(ols_formula_selling_price,data=zdata_reg[zdata_reg$Listing_price<zdata_reg$listing_q2])
regs[[2]] <- felm(iv_formula_selling_price,data=zdata_reg[zdata_reg$Listing_price<zdata_reg$listing_q2])
regs[[3]] <- felm(ols_formula_selling_price,data=zdata_reg[zdata_reg$Listing_price>zdata_reg$listing_q2])
regs[[4]] <- felm(iv_formula_selling_price,data=zdata_reg[zdata_reg$Listing_price>zdata_reg$listing_q2])

printtable(regs,column.labels = c("Low Value (OLS)","Low Value (IV)","High Value (OLS)","High Value (IV)"),note=note,lines=list(""))
```




# Effect on Listing price: Variation by Census tract median age
```{r}

temp <- zd[!duplicated(zd$GEOID)]
median_age <- median(temp$medianage,na.rm = TRUE)

regs <- list()
regs[[1]] <- felm(ols_formula,data=zd[zd$medianage<median_age])
regs[[2]] <- felm(iv_formula,data=zd[zd$medianage<median_age])
regs[[3]] <- felm(ols_formula,data=zd[zd$medianage>median_age])
regs[[4]] <- felm(iv_formula,data=zd[zd$medianage>median_age])

printtable(regs,column.labels = c("Low Age (OLS)","Low Age (IV)","High Age (OLS)","High Age (IV)"),note=note,lines=list(""))
```





# Effect on Listing price: Variation by Census tract median household income
```{r}

temp <- zd[!duplicated(zd$GEOID)]
medianhouseholdincome <- median(temp$medianhouseholdincome,na.rm = TRUE)

regs <- list()
regs[[1]] <- felm(ols_formula,data=zd[zd$medianhouseholdincome<67250])
regs[[2]] <- felm(iv_formula,data=zd[zd$medianhouseholdincome<67250])
regs[[3]] <- felm(ols_formula,data=zd[zd$medianhouseholdincome>67250])
regs[[4]] <- felm(iv_formula,data=zd[zd$medianhouseholdincome>67250])

printtable(regs,column.labels = c("Low Income (OLS)","Low Income (IV)","High Income (OLS)","High Income (IV)"),note=note,lines=list(""))
```










# Effect on Listing price: Variation by Cold and Hot Markets
Cold: Last 3 year house price growth less than median <br/>
Hot: Last 3 year house price growth greater than median
```{r}
  zhvi <- read.csv(file="C:/Users/dnratnadiwakara/Documents/sunkcost_2019/Zip_Zhvi_AllHomes.csv",stringsAsFactors = FALSE)
  zhvi <- zhvi[zhvi$State %in% c("CA"),]
  zhvi[,c("RegionID","City","State","Metro","CountyName","SizeRank")] <- NULL
  zhvi <- melt(zhvi,id.vars = c("RegionName"))
  zhvi['month'] <- sapply(zhvi$variable,function(x) as.Date(paste(gsub("\\.","-",substr(x,2,8)),"-01",sep="")))
  zhvi$month <- as.Date(zhvi$month,origin = "1970-01-01")
  zhvi$variable <- NULL
  names(zhvi) <- c("zip","HPI","month")
  zhvi['purch_month_no']<-as.numeric(format(zhvi$month,"%m"))
  zhvi <- zhvi[zhvi$purch_month_no==1,]
  zhvi['year'] <- as.numeric(format(zhvi$month,"%Y"))
  zhvi[,c("month","purch_month_no")] <- NULL
  
  zhvi2 <- zhvi
  zhvi2$year <- zhvi2$year+3
  names(zhvi2) <- c("zip","HPI_3","year")
  
  zhvi <-merge(zhvi,zhvi2,by=c("zip","year"))
  zhvi['HPI_growth'] <- zhvi$HPI/zhvi$HPI_3-1
  zhvi[,c("HPI","HPI_3")] <- NULL
  names(zhvi) <- c("zip","ListingYear","HPI_growth")
  
zd <- merge(zd,zhvi,by=c("zip","ListingYear"),all.x = TRUE)
median_HPI_gr <- median(zhvi[zhvi$ListingYear==2016,]$HPI_growth,na.rm = TRUE)
low_zip <-zhvi[zhvi$HPI_growth<median_HPI_gr & zhvi$ListingYear==2016,]$zip
    
regs <- list()
regs[[1]] <- felm(ols_formula,data=zdata_reg[zdata_reg$zip %in% low_zip])
regs[[2]] <- felm(iv_formula,data=zdata_reg[zdata_reg$zip %in% low_zip])
regs[[3]] <- felm(ols_formula,data=zdata_reg[!zdata_reg$zip %in% low_zip])
regs[[4]] <- felm(iv_formula,data=zdata_reg[!zdata_reg$zip %in% low_zip])

printtable(regs,column.labels = c("Cold (OLS)","Cold (IV)","Hot (OLS)","Hot (IV)"),note=note,lines=list(""))
```







# Effect on Listing price: Variation by Market Activity
```{r}
regs <- list()
regs[[1]] <- felm(ols_formula,data=zd[zd$low_activiy==1])
regs[[2]] <- felm(iv_formula,data=zd[zd$low_activiy==1])
regs[[3]] <- felm(ols_formula,data=zd[zd$low_activiy==0])
regs[[4]] <- felm(iv_formula,data=zd[zd$low_activiy==0])

printtable(regs,column.labels = c("Low Activity (OLS)","Low Activity (IV)","High Activity (OLS)","High Activity (IV)"),note=note,lines=list(""))
```


# Effect on Listing price: Variation by Loan-to-Value Ratio
```{r}
regs <- list()
regs[[1]] <- felm(ols_formula,data=zd[zd$LTV_prev<0.7])
regs[[2]] <- felm(iv_formula,data=zd[zd$LTV_prev<0.7])
regs[[3]] <- felm(ols_formula,data=zd[zd$LTV_prev>=0.7])
regs[[4]] <- felm(iv_formula,data=zd[zd$LTV_prev>=0.7])

printtable(regs,column.labels = c("LTV<.7 (OLS)","LTV<.7 (IV)","LTV>.7 (OLS)","LTV>.7 (IV)"),note=note,lines=list(""))
```

# Transaction Outcome
```{r}
controls = "log(adj_purch_price)+log(nominal_loss)+beds+baths+sqft+avg_school_rating+avg_school_distance+walk_score+log(house_age)+log(LotSizeSquareFeet)+LTV_prev"
fe = "|zip_list_month|"
cluster = "|zip"
instruments = "ownership_years" #
endo_var = "Property_tax_rate_last_year"



regs <- list()
regs[[1]] <- felm(as.formula(paste("log(sales_price)~Property_tax_rate_last_year+",controls,fe,"0",cluster,sep="")),data=zd)
regs[[2]] <- felm(as.formula(paste("log(sales_price)~",controls,fe,"(",endo_var,"~",instruments,")",cluster,sep="")),data=zd)
regs[[3]] <- felm(as.formula(paste("log(Time_on_market)~Property_tax_rate_last_year+",controls,fe,"0",cluster,sep="")),data=zd)
regs[[4]] <- felm(as.formula(paste("log(Time_on_market)~",controls,fe,"(",endo_var,"~",instruments,")",cluster,sep="")),data=zd)



condf <- list(
  c("Fixed Effects","Zip X List Month","Zip x List Month","Zip X List Month","Zip X List Month"),
  c("Cluster","Zip","Zip","zip","Zip")
  )
printtable(regs,column.labels = c("OLS (Sale Price)","IV (Sale Price)","OLS (Time)","IV (Time)"),note="",lines=condf)

```

# RD: Using June Cutoff for assessment of new purchases

## 2016 assesssment of homes purchased in 2015
```{r}
rdd_tax <- readRDS("C:/Users/dnratnadiwakara/Documents/sunkcost_2019/asmt_tax_2016_CA.rds")
rdd_tax[,x:=as.numeric(rdd_tax$DocumentDate)]
rdd_tax[,purch_week:=as.numeric(strftime(rdd_tax$DocumentDate,format="%V"))-19]

# t <- rdd_tax[sample(1:nrow(rdd_tax),size = 20000),]
rdd_tax <- rdd_tax[rdd_tax$asmt_sales>=1]
rdd_tax <- rdd_tax[rdd_tax$asmt_sales>=0.9 & rdd_tax$asmt_sales<1.02 & rdd_tax$purch_week<30 & rdd_tax$tax_sales>0]

rdd_tax <- rdd_tax[,.(asmt_sales=mean(asmt_sales)),by=list(purch_week)]
# rdplot(rdd_tax$asmt_sales,rdd_tax$purch_week,p=1,c=20)

ggplot(rdd_tax,aes(x=purch_week,y=asmt_sales)) + geom_point() + 
  xlab("Purchase week (Weeks since June 01 2015)")+
  ylab("2016 Asmt. Value/2015 Purchase Price")+
  theme_minimal()+
  geom_vline(xintercept = 0)
```



```{r}
# temp <- zdata[zdata$ListingYear>2014 & zdata$Listing_premium>0.8 & zdata$Listing_premium<1.2 & zdata$ownership_years>=4 &  zdata$ownership_years<=118 & zdata$house_age>0  & zdata$PurchaseYear<2008]
temp <- zdata_reg[zdata_reg$PurchaseYear>2006 & zdata_reg$ownership_years>2]
temp[,purch_month_no:=as.numeric(format(temp$PurchaseMonth,"%m"))]
temp[,sale_month_no:=as.numeric(format(temp$sale_date,"%m"))]
temp = temp[temp$purch_month_no %in% 1:10]
temp <- temp[!is.na(temp$adj_purch_price) & !is.na(temp$GEOID)]

adj_proptax <- felm(Property_tax_rate_last_year~log(purchase_hpi)|GEOID+purchase_list_year,data=temp)
adj_proptax_resid <- data.frame(adj_proptax$residuals)
names(adj_proptax_resid) <- c("adj_proptax_resid")

adj_list <- felm(log(Listing_price)~log(adj_purch_price)|GEOID+purchase_list_year,data=temp)
adj_list_resid <- data.frame(adj_list$residuals)
names(adj_list_resid) <- c("adj_list_resid")

adj_sale <- felm(log(Selling_price)~log(adj_purch_price)|GEOID+purchase_list_year,data=temp)
adj_sale_resid <- data.frame(adj_sale$residuals)
names(adj_sale_resid) <- c("adj_sale_resid")

adj_purch <- felm(log(Purchase_price)~log(purchase_hpi)|GEOID+purchase_list_year,data=temp)
adj_purch_resid <- data.frame(adj_purch$residuals)
names(adj_purch_resid) <- c("adj_purch_resid")

adj_est <- felm(sale_month_no~0|GEOID+purchase_list_year,data=temp)
adj_est_resid <- data.frame(adj_est$residuals)
names(adj_est_resid) <- c("adj_est_resid")

adj_sqft <- felm(sqft~0|GEOID+purchase_list_year,data=temp)
adj_sqft_resid <- data.frame(adj_sqft$residuals)
names(adj_sqft_resid) <- c("adj_sqft_resid")

temp <- cbind(temp,adj_proptax_resid)
temp <- cbind(temp,adj_list_resid)
temp <- cbind(temp,adj_sale_resid)
temp <- cbind(temp,adj_purch_resid)
temp <- cbind(temp,adj_est_resid)
temp <- cbind(temp,adj_sqft_resid)

temp[,DocumentDate_prev:=as.Date(temp$DocumentDate_prev,origin = "1970-01-01")]
temp[,purch_week:=as.numeric(strftime(temp$DocumentDate_prev,format="%V"))-20]
temp<-temp[temp$purch_week<25]

poly =0
br=0
# temp_1 <- temp[,.(adj_list_resid=mean(adj_list_resid)),by=list(purch_week)]
par(mfrow=c(2,3))
rdplot(temp$adj_proptax_resid,temp$purch_week,p=poly,c=br,x.label = "",title = "Property tax rate*",y.label = "")
rdplot(temp$adj_list_resid,temp$purch_week,p=poly,c=br,x.label = "",title = "log(List price)**",y.label = "")
rdplot(temp$adj_sale_resid,temp$purch_week,p=poly,c=br,x.label = "",title = "log(Sale price)**",y.label = "")
rdplot(temp$adj_purch_resid,temp$purch_week,p=poly,c=br,x.label = "Purchased week (June 01 = 0)",title = "log(Purchase price)*",y.label = "")
rdplot(temp$adj_est_resid,temp$purch_week,p=poly,c=br,x.label = "Purchased week (June 01 = 0)",title = "Sale month",y.label = "")
rdplot(temp$adj_sqft_resid,temp$purch_week,p=poly,c=br,x.label = "Purchased week (June 01 = 0)",title = "House area",y.label = "")

```

# Prop. 8 for identification

```{r}

note =c("Fixed Effects: census tract, Purchase Year x List Year","Standard Errors clustered by census tract")


temp <- zdata_reg[zdata_reg$ListingYear %in% 2016:2017 & zdata_reg$PurchaseYear %in% 2004:2005 & zdata_reg$baths>0 & zdata_reg$beds>0 & zdata_reg$sqft>0 & zdata_reg$house_age>0 & zdata_reg$LotSizeSquareFeet>0]

formula_prop_tax <- as.formula("log(prop_tax_prev_year)~log(Purchase_price)+log(adj_purch_price)|GEOID+purchase_list_year|0|GEOID")
formula_list_price_1 <- as.formula("log(Listing_price)~abnormal_prop_tax+log(adj_purch_price)|GEOID+purchase_list_year|0|zip")

regs <- list()
regs[[1]] <- felm(formula_prop_tax,data=temp)

temp[,abnormal_prop_tax:= regs[[1]]$residuals]
regs[[2]] <- felm(formula_list_price_1,data=temp)


printtable(regs,column.labels = c("log(Prop. Tax)","log(Listing price)"),note=note,lines=list(""))
```


